<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Site 8083</title>
  </head>
  <body>
    <h1>Site 8083 ä¸»é¡µ</h1>
    <button onclick="postMsgToParent()">å‘é€æ•°æ®ç»™ 8081</button>
    <button onclick="pullMsgFromParent()">ä» 8081 è·å–æ•°æ®</button>
    <script>
      function postMsgToParent() {
        var targetOrigin = "http://localhost:8081/";
        parent.postMessage("8083 copy that!", targetOrigin);
      }
      async function pullMsgFromParent() {
        var targetOrigin = "http://localhost:8081/";
        // é€šè¿‡ promise åŒ…è£…çš„ XMLHttpRequest è·å–è¯·æ±‚æ•°æ®
        // let userInfo = await getUser();

        // é€šè¿‡ fetch è·å–è¯·æ±‚æ•°æ®
        // fetch("/getUser")
        //   .then((response) => response.json())
        //   .then((json) => console.log(json))
        //   .catch((err) => console.log("Request Failed", err));

        // é€šè¿‡ await ç®€å†™ fetch è¯·æ±‚ç»“æœ
        try {
          var res = await fetch("/getUser", { method: "GET" });
          var userInfo = await res.json();
        } catch (error) {
          console.log(`ğŸš€ ~ pullMsgFromParent ~ error`, error);
        }
        // var userInfo = await (await fetch("/getUser", { method: "GET" })).json();
        // console.log(`ğŸš€ ~ pullMsgFromParent ~ userInfo`, userInfo)
        parent.postMessage(userInfo, targetOrigin);
      }
      window.addEventListener("message", function (e) {
        console.log("æ¥è‡ªçˆ¶é¡µé¢çš„æ¶ˆæ¯: ", e.data);
      });

      function getUser() {
        // åŒ…è£…æˆ promise å¯¹è±¡
        return new Promise(function (resolve, reject) {
          var xhr = new XMLHttpRequest();
          // var response;
          xhr.open("GET", "/getUser", true);
          xhr.onload = function () {
            // response = await xhr.response;
            // console.log(`ğŸš€ ~ xhr.response`, xhr.response);
            resolve(JSON.parse(xhr.response));
          };
          xhr.send();
        });

        // return fetch
      }

      // xhr.open("get", "http://localhost:8083/getUser", true);
      // xhr.onload = function () {
      //   console.log(`ğŸš€ ~ xhr.response`, xhr.response);
      // };
      // xhr.send();
    </script>
  </body>
</html>
